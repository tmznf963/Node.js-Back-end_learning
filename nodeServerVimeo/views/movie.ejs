<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>movie list</title>
        <link rel="stylesheet" href="/css/ui.css">
    </head>
    <body>

    <header>
        <div><a href="/">메인페이지</a></div>
        <div><a href="/logout">logout</a></div>
    </header>

    <h1>Movie list API Test</h1>

    <section class="showWrap">
        <ul>
            <li class="get_all">
                <button>모든영화보기</button>
                <section class="showResult"></section>
            </li>

            <li class="get_id">
                <input type="text" name="keyword">
                <button>영화상세정보</button>
                <section class="showResult"></section>
            </li>
        </ul>
    </section>


    <script>
        document.querySelector('.showWrap').addEventListener('click', function(e) {
            let url, method, data, fn;
            const target = e.target;
            const li = target.closest('LI');
            const showResult = li.querySelector(".showResult");
            const type = li.className;
            if(target.tagName !== "BUTTON") return;
            switch (type) {
                case "get_all":
                    url = "/movie";
                    method = "GET";
                    fn = function(result) {
                        if(result.result === 1) {
                            let titles = result.data.reduce(function(pre,next){
                                pre += "<li>" + next.movie_title + "</li>"
                                return pre;
                            },"");
                            showResult.innerHTML = "<ul>" + titles + "</ul>";
                        } else {
                         showResult.innerHTML = "list not found";
                        }
                    }
                    break;
                case "get_id":
                    url = "/movie/"+li.getElementsByTagName("input")[0].value;
                    method = "GET";
                    fn = function(result) {
                        if(result.result === 1) {
                          let titles = result.data.reduce(function(pre,next){
                              pre += "<li>" + next.code + "</li>"
                              return pre;
                          },"");
                          showResult.innerHTML = "<ul>" + codes + "</ul>";
                          // var i;
                          // for(i = 0 ; i < result.data.length ; i++){
                          //   showResult.innerHTML = result.data.length
                          //   showResult.innerHTML = result.data[i].code;//result.data[0].Actors
                          // }
                        }else {
                            showResult.innerHTML = "해당하는 영화가 없네요..";
                        }
                    }
                    break;
                default:
                    // statements_def
                    console.log("default");
                    break;
            }
            sendAjax(url, method, data, fn);
        })
        //@data : json format.
        function sendAjax(url, method, data, fn){
            const xhr = new XMLHttpRequest();
            xhr.open(method, url);
            if(data) {
                data = JSON.stringify(data);
                xhr.setRequestHeader('Content-Type', "application/json");
            } else {
                data = null;
            }
            xhr.send(data);
            xhr.addEventListener('load', function() {
                const result = JSON.parse(xhr.responseText);
                fn(result);
            });
        }
    </script>

    </body>
</html>
